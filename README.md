# AstrBot 图片收集插件

## 功能介绍

这是一个功能强大的AstrBot插件，可以自动收集群友发送的图片，支持多种去重和压缩选项，并在用户发送消息时随机回复其图库中的图片。

### 核心功能

- ✅ **自动收集图片**：自动监听群消息中的图片并保存
- ✅ **按用户分组**：每个用户有独立的图库
- ✅ **MD5精确去重**：使用MD5哈希避免重复保存相同图片
- ✅ **感知哈希去重**：可识别经过轻微修改的同一张图片（压缩、缩放、水印等）
- ✅ **自动压缩**：支持尺寸压缩、质量压缩、格式优化
- ✅ **随机回复**：用户发送消息时自动随机发送其图库图片
- ✅ **丰富配置**：提供多种配置选项，灵活控制插件行为

## 安装方法

1. 将插件文件夹复制到 AstrBot 的 `data/plugins/` 目录
2. 在 AstrBot WebUI 中安装插件依赖
3. 在插件管理中启用本插件

## 配置说明

### 基础功能配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `enable_save` | 是否启用图片保存 | true |
| `enable_random_send` | 是否启用随机发送 | true |
| `min_images` | 最少图片数（达到此数量才触发随机发送） | 1 |
| `save_on_image_msg` | 发送图片消息时是否也随机回复 | false |
| `exclude_words` | 排除词列表（包含这些词的消息不触发随机发送） | ["帮助", "查询", "命令", "菜单"] |

### 图片压缩配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `enable_compression` | 是否启用图片压缩 | true |
| `max_width` | 最大宽度（像素） | 1920 |
| `max_height` | 最大高度（像素） | 1080 |
| `jpeg_quality` | JPEG质量（1-100） | 85 |
| `max_file_size` | 最大文件大小（MB） | 2 |
| `convert_to_jpeg` | PNG转JPEG | true |

### 去重配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `enable_md5_dedup` | 启用MD5精确去重 | true |
| `enable_phash` | 启用感知哈希去重 | true |
| `phash_threshold` | 相似度阈值（汉明距离，0-20） | 5 |
| `dedup_scope` | 去重范围（user/group/global） | user |

## 使用方法

### 自动收集和随机回复

插件启用后，会自动：
1. 监听群消息中的图片并保存
2. 当用户发送非图片消息时，随机发送其图库中的一张图片

### 指令

- `/图片统计` - 查看当前群的图片收集统计
- `/我的图片` - 查看自己收集的图片数量

## 数据存储

图片存储在以下目录结构中：

```
data/plugin_data/image_collector/
├── qq/                          # 平台目录
│   └── 123456789/              # 群ID
│       └── 987654321/          # 用户ID
│           ├── images/         # 图片文件
│           │   ├── 1700000000_abc123def456.jpg
│           │   └── ...
│           └── index.json      # 索引文件
```

## 技术特性

### 感知哈希算法

插件使用多种感知哈希算法来识别相似图片：
- **Average Hash (aHash)**：平均哈希
- **Perceptual Hash (pHash)**：感知哈希（基于DCT）
- **Difference Hash (dHash)**：差异哈希
- **Wavelet Hash (wHash)**：小波哈希

通过汉明距离判断相似性，可识别：
- 轻微压缩的图片
- 缩放后的图片
- 格式转换的图片
- 添加轻微水印的图片

### 压缩策略

1. **尺寸压缩**：保持比例缩放到指定尺寸以下
2. **质量压缩**：迭代压缩直到满足文件大小要求
3. **格式优化**：PNG自动转换为JPEG以节省空间
4. **透明处理**：转换时智能处理透明通道

## 依赖项

- aiohttp >= 3.9.0
- Pillow >= 10.0.0
- ImageHash >= 4.3.1

## 注意事项

1. 首次使用需要安装依赖
2. 图片存储会占用磁盘空间，请定期清理
3. 感知哈希阈值越小，匹配越严格
4. 去重范围设置为 global 时，所有用户共享去重库

## 版本历史

### v1.0.0
- 初始版本
- 支持图片收集、去重、压缩
- 支持随机回复功能
- 支持统计和查询指令

## 许可证

MIT License

## 作者

Cline

## 反馈与支持

如有问题或建议，请在 GitHub 仓库提交 Issue。