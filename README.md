# AstrBot 图库 (图片收集插件)

## 功能介绍

这是一个功能强大的AstrBot插件，可以自动收集群友发送的图片，支持多种去重和压缩选项，并在用户发送消息时随机回复其图库中的图片。

### 核心功能

- ✅ **自动收集图片**：自动监听群消息中的图片并保存
- ✅ **按用户分组**：每个用户有独立的图库
- ✅ **MD5精确去重**：使用MD5哈希避免重复保存相同图片
- ✅ **感知哈希去重**：可识别经过轻微修改的同一张图片（压缩、缩放、水印等）
- ✅ **自动压缩**：支持尺寸压缩、质量压缩、格式优化
- ✅ **GIF动图保留**：自动识别并保留GIF动图，可配置是否压缩
- ✅ **随机回复**：用户发送消息时自动随机发送其图库图片
- ✅ **指令忽略**：自动忽略所有指令消息，避免干扰
- ✅ **丰富配置**：提供18种配置选项，灵活控制插件行为

## 安装方法

1. 将插件文件夹复制到 AstrBot 的 `data/plugins/` 目录
2. 在 AstrBot WebUI 中安装插件依赖
3. 在插件管理中启用本插件

## 配置说明

### 基础功能配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `enable_save` | 是否启用图片保存 | true |
| `enable_random_send` | 是否启用随机发送 | true |
| `random_send_probability` | 随机发送概率（0.0-1.0） | 0.3 |
| `min_images` | 最少图片数（达到此数量才触发随机发送） | 1 |
| `save_on_image_msg` | 发送图片消息时是否也随机回复 | false |
| `exclude_words` | 排除词列表（包含这些词的消息不触发随机发送） | ["帮助", "查询", "命令", "菜单", "图片统计", "我的图片"] |
| `ignore_commands` | 忽略所有指令（以配置前缀开头的消息） | true |
| `command_prefixes` | 指令前缀列表 | ["/"] |

**概率说明**：
- `random_send_probability` 控制每次消息触发随机发送的概率
- 0.3 表示 30% 的概率会触发随机发送
- 1.0 表示每次都会触发，0.0 表示永不触发
- 默认 30% 可以避免过于频繁的干扰

**指令忽略说明**：
- `ignore_commands` 默认启用，会忽略以配置的前缀开头的消息
- `command_prefixes` 可以自定义多个指令前缀，如 `["/", "#", "！"]`
- **注意**：由于AstrBot框架的特性，指令可能无法被识别（框架处理后message_str可能不包含前缀）
- 建议配合"排除词列表"使用，将常用指令词加入排除列表

**自定义指令前缀示例**：
- `["/"]` - 只忽略以 `/` 开头的消息（默认）
- `["/", "#"]` - 忽略以 `/` 或 `#` 开头的消息
- `["/", "#", "！"]` - 忽略以 `/`、`#` 或 `！` 开头的消息
- `[]` - 空列表表示不忽略任何消息

### 图片压缩配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `enable_compression` | 是否启用图片压缩 | true |
| `force_compression` | 强制压缩（无论图片大小如何都进行压缩） | false |
| `preserve_gif` | 保留GIF动图（不压缩） | true |
| `target_size_kb` | 目标文件大小（KB），0表示不限制 | 0 |
| `max_width` | 最大宽度（像素） | 1920 |
| `max_height` | 最大高度（像素） | 1080 |
| `jpeg_quality` | JPEG质量（1-100） | 85 |
| `max_file_size` | 最大文件大小（MB） | 2 |
| `convert_to_jpeg` | PNG转JPEG | true |
| `gif_max_width` | GIF最大宽度（像素） | 800 |
| `gif_max_height` | GIF最大高度（像素） | 600 |
| `gif_min_dimension` | GIF最小尺寸限制（像素） | 100 |
| `gif_max_frames` | GIF最大帧数限制（0=不限制） | 0 |
| `gif_frame_skip_method` | 抽帧方式（uniform/smart） | uniform |
| `gif_convert_to_webp` | GIF转WebP格式（压缩率更高） | false |
| `gif_use_mediancut` | 使用MEDIANCUT量化算法（质量更优） | true |

**压缩模式说明**：

1. **标准压缩模式**（默认）：
   - 当 `force_compression` 为 `false` 且 `target_size_kb` 为 `0` 时
   - 只压缩超过 `max_file_size` 的图片
   - 例如：设置 `max_file_size` 为 2MB，只有超过 2MB 的图片才会被压缩

2. **强制压缩模式**：
   - 当 `force_compression` 为 `true` 时
   - 对所有图片进行压缩，无论原始大小如何
   - 适用于希望统一图片大小的场景

3. **目标大小压缩模式**：
   - 当 `target_size_kb` 大于 `0` 时
   - 将图片尽可能压缩到指定大小以下（KB）
   - 使用更激进的压缩策略以快速达到目标大小
   - 例如：设置 `target_size_kb` 为 500，图片将尽可能压缩到 500KB 以下

**压缩优先级**：
- 如果同时设置了 `force_compression` 和 `target_size_kb`，将使用目标大小进行压缩
- 如果只设置了 `force_compression`，将使用 `max_file_size` 作为压缩目标

### 去重配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `enable_md5_dedup` | 启用MD5精确去重 | true |
| `enable_phash` | 启用感知哈希去重 | true |
| `phash_threshold` | 相似度阈值（汉明距离，0-20） | 5 |
| `dedup_scope` | 去重范围（user/group/global） | user |

## 使用方法

### 自动收集和随机回复

插件启用后，会自动：
1. 监听群消息中的图片并保存
2. 当用户发送非图片消息时，随机发送其图库中的一张图片

### 指令

- `/图片统计` - 查看当前群的图片收集统计
- `/我的图片` - 查看自己收集的图片数量
- `/清空图片` - 清空所有收集的图片（仅限管理员）
  - 用法：`/清空图片` 查看统计信息和确认提示
  - 用法：`/清空图片 确认` 执行清空操作
  - ⚠️ 此操作不可逆，请谨慎使用

## 数据存储

图片存储在以下目录结构中：

```
data/plugin_data/image_collector/
├── qq/                          # 平台目录
│   └── 123456789/              # 群ID
│       └── 987654321/          # 用户ID
│           ├── images/         # 图片文件
│           │   ├── 1700000000_abc123def456.jpg
│           │   └── ...
│           └── index.json      # 索引文件
```

## 技术特性

### 感知哈希算法

插件使用多种感知哈希算法来识别相似图片：
- **Average Hash (aHash)**：平均哈希
- **Perceptual Hash (pHash)**：感知哈希（基于DCT）
- **Difference Hash (dHash)**：差异哈希
- **Wavelet Hash (wHash)**：小波哈希

通过汉明距离判断相似性，可识别：
- 轻微压缩的图片
- 缩放后的图片
- 格式转换的图片
- 添加轻微水印的图片

### 压缩策略

#### 静态图片压缩
1. **尺寸压缩**：保持比例缩放到指定尺寸以下
2. **质量压缩**：迭代压缩直到满足文件大小要求
3. **格式优化**：PNG自动转换为JPEG以节省空间
4. **透明处理**：转换时智能处理透明通道

#### GIF动图压缩（优化版）

当启用GIF压缩时（`preserve_gif` 为 `false`），插件会使用四阶段压缩策略：

**阶段1：帧数优化（抽帧）**
- 通过 `gif_max_frames` 限制最大帧数
- 支持两种抽帧模式：
  - `uniform` - 均匀抽帧，保持动画流畅性
  - `smart` - 智能抽帧，保留首尾帧和关键帧
- 对高帧数GIF（如60fps）效果显著

**阶段2：智能缩放**
- 使用二分查找算法快速定位最佳缩放比例
- 最多5次迭代即可找到最优解
- 根据目标大小动态调整搜索范围
- 支持早期终止，达到目标立即停止

**阶段3：颜色深度优化**
- 使用MEDIANCUT量化算法（质量更优）
- 逐步减少颜色深度（256→128→64→32）
- 自动降级到默认方法，确保兼容性

**阶段4：WebP转换（可选）**
- 当GIF压缩效果不佳时，自动转换为WebP格式
- WebP压缩率通常比GIF高20-40%
- 转换失败时保留GIF格式

**GIF压缩配置示例**：

```json
{
  "preserve_gif": false,
  "gif_max_frames": 30,
  "gif_frame_skip_method": "uniform",
  "gif_convert_to_webp": true,
  "gif_use_mediancut": true
}
```

**性能提升**：
- 压缩速度提升30-50%（二分查找 + 早期终止）
- 压缩率提升20-40%（帧数优化 + 智能缩放）

**注意**：GIF动图默认不进行压缩以保持动画效果，可通过配置 `preserve_gif` 修改此行为。

## 依赖项

- aiohttp >= 3.9.0
- Pillow >= 10.0.0
- ImageHash >= 4.3.1

## 注意事项

1. 首次使用需要安装依赖
2. 图片存储会占用磁盘空间，请定期清理
3. 感知哈希阈值越小，匹配越严格
4. 去重范围设置为 global 时，所有用户共享去重库
5. GIF动图默认不压缩以保持动画效果，会占用较多存储空间

## 许可证

MIT License

## 作者

Sakura520222

## 反馈与支持

如有问题或建议，请在 GitHub 仓库提交 Issue。